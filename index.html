<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WWS Secure Audio Call</title>
<style>
body { 
    font-family: Arial, sans-serif; 
    text-align: center; 
    background: #111; 
    color: white; 
    margin: 0;
    padding: 20px;
}
.container {
    max-width: 600px;
    margin: 0 auto;
    padding: 20px;
    background: #222;
    border-radius: 10px;
    box-shadow: 0 0 20px rgba(0,0,0,0.5);
}
button { 
    padding: 12px 24px; 
    margin: 10px; 
    background: #4CAF50;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 16px;
    transition: background 0.3s;
}
button:hover {
    background: #45a049;
}
button:disabled {
    background: #666;
    cursor: not-allowed;
}
input { 
    padding: 12px; 
    width: 200px;
    border: 1px solid #444;
    border-radius: 5px;
    background: #333;
    color: white;
}
.status {
    margin: 20px 0;
    padding: 10px;
    background: #333;
    border-radius: 5px;
}
.log {
    background: #000;
    color: #0f0;
    padding: 10px;
    border-radius: 5px;
    text-align: left;
    max-height: 200px;
    overflow-y: auto;
    font-family: monospace;
    font-size: 12px;
}
.connection-status {
    display: inline-block;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    margin-right: 5px;
}
.connected { background: #0f0; }
.disconnected { background: #f00; }
.connecting { background: #ff0; }
</style>
</head>
<body>

<div class="container">
    <h2>üîí Secure Audio Call</h2>
    
    <div class="status">
        <p>ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: <span id="userIdDisplay"></span></p>
        <p>–ö–æ–º–Ω–∞—Ç–∞: <span id="roomIdDisplay">–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ</span></p>
        <p>–°—Ç–∞—Ç—É—Å: 
            <span class="connection-status disconnected" id="connectionStatus"></span>
            <span id="statusText">–û—Ç–∫–ª—é—á–µ–Ω–æ</span>
        </p>
    </div>
    
    <button onclick="createRoom()" id="createBtn">–°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É</button>
    
    <br><br>
    
    <input id="roomInput" placeholder="–í–≤–µ–¥–∏—Ç–µ ID –∫–æ–º–Ω–∞—Ç—ã">
    <button onclick="joinRoom()" id="joinBtn">–í–æ–π—Ç–∏ –≤ –∫–æ–º–Ω–∞—Ç—É</button>
    
    <br><br>
    
    <div class="log" id="log"></div>
</div>

<script>
const API_URL = "https://functions.yandexcloud.net/d4etraj6pl3ep8uj8cd8";

let localStream = null;
let roomId = null;
let userId = null;
let signalingChannel = null;
let peerConnections = {};
let iceCandidatesQueue = {};

// –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
function log(message, type = 'info') {
    const logElement = document.getElementById('log');
    const timestamp = new Date().toLocaleTimeString();
    const color = type === 'error' ? '#f00' : type === 'warning' ? '#ff0' : '#0f0';
    logElement.innerHTML += `<span style="color:${color}">[${timestamp}] ${message}</span><br>`;
    logElement.scrollTop = logElement.scrollHeight;
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
function updateStatus(message, state = 'disconnected') {
    document.getElementById('statusText').textContent = message;
    const statusElement = document.getElementById('connectionStatus');
    statusElement.className = 'connection-status ' + state;
    
    if (state === 'connected') statusElement.style.background = '#0f0';
    else if (state === 'connecting') statusElement.style.background = '#ff0';
    else statusElement.style.background = '#f00';
}

// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
function generateUserId() {
    return 'user_' + Math.random().toString(36).substring(2, 15) + 
           Math.random().toString(36).substring(2, 15);
}

// –ó–∞–ø—Ä–æ—Å –∫ API
async function apiCall(endpoint, method = 'GET', data = null) {
    try {
        const options = {
            method: method,
            headers: {
                'Content-Type': 'application/json',
                'X-User-Id': userId || 'anonymous'
            }
        };
        
        if (data) {
            options.body = JSON.stringify(data);
        }
        
        log(`–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞: ${method} ${endpoint}`);
        const response = await fetch(`${API_URL}${endpoint}`, options);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        log(`–ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç –æ—Ç ${endpoint}`);
        return result;
    } catch (error) {
        log(`–û—à–∏–±–∫–∞ API: ${error.message}`, 'error');
        throw error;
    }
}

// –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã
async function createRoom() {
    try {
        updateStatus('–°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã...', 'connecting');
        log('–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –∫–æ–º–Ω–∞—Ç—ã...');
        
        const buttons = ['createBtn', 'joinBtn'];
        buttons.forEach(id => document.getElementById(id).disabled = true);
        
        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        userId = generateUserId();
        document.getElementById('userIdDisplay').textContent = userId;
        
        // –°–æ–∑–¥–∞–µ–º –∫–æ–º–Ω–∞—Ç—É —á–µ—Ä–µ–∑ API
        const result = await apiCall('/room', 'POST', { userId });
        
        if (result.success && result.roomId) {
            roomId = result.roomId;
            document.getElementById('roomIdDisplay').textContent = roomId;
            updateStatus('–ö–æ–º–Ω–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∞', 'connected');
            log(`–ö–æ–º–Ω–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∞: ${roomId}`);
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω—è–µ–º—Å—è –∫ —Å–æ–∑–¥–∞–Ω–Ω–æ–π –∫–æ–º–Ω–∞—Ç–µ
            await joinExistingRoom(roomId);
            
            alert(`‚úÖ –ö–æ–º–Ω–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∞!\nID: ${roomId}\n–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å —ç—Ç–∏–º ID —Å –¥—Ä—É–≥–∏–º–∏ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏.`);
        } else {
            throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É');
        }
        
        buttons.forEach(id => document.getElementById(id).disabled = false);
    } catch (error) {
        updateStatus('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è', 'disconnected');
        log(`–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–æ–º–Ω–∞—Ç—ã: ${error.message}`, 'error');
        alert(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`);
        
        ['createBtn', 'joinBtn'].forEach(id => document.getElementById(id).disabled = false);
    }
}

// –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∫ –∫–æ–º–Ω–∞—Ç–µ
async function joinRoom() {
    const inputRoomId = document.getElementById('roomInput').value.trim().toUpperCase();
    
    if (!inputRoomId) {
        alert('–í–≤–µ–¥–∏—Ç–µ ID –∫–æ–º–Ω–∞—Ç—ã');
        return;
    }
    
    if (inputRoomId.length !== 6) {
        alert('ID –∫–æ–º–Ω–∞—Ç—ã –¥–æ–ª–∂–µ–Ω —Å–æ—Å—Ç–æ—è—Ç—å –∏–∑ 6 —Å–∏–º–≤–æ–ª–æ–≤');
        return;
    }
    
    await joinExistingRoom(inputRoomId);
}

// –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –∫–æ–º–Ω–∞—Ç–µ
async function joinExistingRoom(targetRoomId) {
    try {
        updateStatus('–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∫–æ–º–Ω–∞—Ç–µ...', 'connecting');
        log(`–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∫ –∫–æ–º–Ω–∞—Ç–µ: ${targetRoomId}`);
        
        const buttons = ['createBtn', 'joinBtn'];
        buttons.forEach(id => document.getElementById(id).disabled = true);
        
        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å–ª–∏ –µ—â–µ –Ω–µ—Ç
        if (!userId) {
            userId = generateUserId();
            document.getElementById('userIdDisplay').textContent = userId;
        }
        
        // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É
        try {
            localStream = await navigator.mediaDevices.getUserMedia({ 
                audio: {
                    echoCancellation: true,
                    noiseSuppression: true,
                    autoGainControl: true
                },
                video: false
            });
            log('–ú–∏–∫—Ä–æ—Ñ–æ–Ω –ø–æ–¥–∫–ª—é—á–µ–Ω');
        } catch (mediaError) {
            throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Ä–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø.');
        }
        
        // –ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–µ–º—Å—è –∫ –∫–æ–º–Ω–∞—Ç–µ —á–µ—Ä–µ–∑ API
        const joinResult = await apiCall(`/room/${targetRoomId}/join`, 'POST', { 
            userId,
            userName: `User_${userId.substring(0, 4)}`
        });
        
        if (!joinResult.success) {
            throw new Error(joinResult.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –∫–æ–º–Ω–∞—Ç–µ');
        }
        
        roomId = targetRoomId;
        document.getElementById('roomIdDisplay').textContent = roomId;
        
        updateStatus('–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ –∫–æ–º–Ω–∞—Ç–µ', 'connected');
        log(`–£—Å–ø–µ—à–Ω–æ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª–∏—Å—å –∫ –∫–æ–º–Ω–∞—Ç–µ ${roomId}`);
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º WebSocket –¥–ª—è —Å–∏–≥–Ω–∞–ª–∏–Ω–≥–∞
        await initSignaling();
        
        // –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
        await fetchParticipants();
        
        buttons.forEach(id => document.getElementById(id).disabled = false);
        
    } catch (error) {
        updateStatus('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è', 'disconnected');
        log(`–û—à–∏–±–∫–∞ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: ${error.message}`, 'error');
        alert(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`);
        
        if (localStream) {
            localStream.getTracks().forEach(track => track.stop());
            localStream = null;
        }
        
        ['createBtn', 'joinBtn'].forEach(id => document.getElementById(id).disabled = false);
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è WebSocket –¥–ª—è —Å–∏–≥–Ω–∞–ª–∏–Ω–≥–∞
async function initSignaling() {
    try {
        log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏–≥–Ω–∞–ª–∏–Ω–≥–∞...');
        
        // –°–æ–∑–¥–∞–µ–º WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
        const wsUrl = API_URL.replace('https://', 'wss://').replace('/room', '/ws');
        signalingChannel = new WebSocket(`${wsUrl}?roomId=${roomId}&userId=${userId}`);
        
        signalingChannel.onopen = () => {
            log('WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
            updateStatus('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ', 'connected');
        };
        
        signalingChannel.onmessage = (event) => {
            try {
                const data = JSON.parse(event.data);
                handleSignalingMessage(data);
            } catch (error) {
                log(`–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: ${error}`, 'error');
            }
        };
        
        signalingChannel.onclose = () => {
            log('WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ', 'warning');
            updateStatus('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Ä–∞–∑–æ—Ä–≤–∞–Ω–æ', 'disconnected');
            
            // –ü—ã—Ç–∞–µ–º—Å—è –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è
            setTimeout(() => {
                if (roomId) {
                    log('–ü–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...');
                    initSignaling();
                }
            }, 3000);
        };
        
        signalingChannel.onerror = (error) => {
            log(`WebSocket –æ—à–∏–±–∫–∞: ${error}`, 'error');
        };
        
    } catch (error) {
        log(`–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ WebSocket: ${error.message}`, 'error');
    }
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–∏–≥–Ω–∞–ª—å–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
function handleSignalingMessage(data) {
    const { type, from, to, payload } = data;
    
    if (to !== userId && to !== 'all') return;
    
    switch (type) {
        case 'offer':
            log(`–ü–æ–ª—É—á–µ–Ω–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –æ—Ç ${from}`);
            handleOffer(from, payload);
            break;
            
        case 'answer':
            log(`–ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç –æ—Ç ${from}`);
            handleAnswer(from, payload);
            break;
            
        case 'ice-candidate':
            log(`–ü–æ–ª—É—á–µ–Ω ICE –∫–∞–Ω–¥–∏–¥–∞—Ç –æ—Ç ${from}`);
            handleIceCandidate(from, payload);
            break;
            
        case 'participant-joined':
            log(`–ù–æ–≤—ã–π —É—á–∞—Å—Ç–Ω–∏–∫: ${from}`);
            handleNewParticipant(from);
            break;
            
        case 'participant-left':
            log(`–£—á–∞—Å—Ç–Ω–∏–∫ –≤—ã—à–µ–ª: ${from}`);
            handleParticipantLeft(from);
            break;
            
        case 'ping':
            // –û—Ç–≤–µ—á–∞–µ–º –Ω–∞ –ø–∏–Ω–≥
            sendSignalingMessage({
                type: 'pong',
                from: userId,
                to: from,
                timestamp: Date.now()
            });
            break;
    }
}

// –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–∏–≥–Ω–∞–ª—å–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
function sendSignalingMessage(message) {
    if (signalingChannel && signalingChannel.readyState === WebSocket.OPEN) {
        signalingChannel.send(JSON.stringify(message));
    } else {
        log('WebSocket –Ω–µ –≥–æ—Ç–æ–≤ –∫ –æ—Ç–ø—Ä–∞–≤–∫–µ', 'warning');
    }
}

// –°–æ–∑–¥–∞–Ω–∏–µ PeerConnection
function createPeerConnection(remoteUserId) {
    try {
        log(`–°–æ–∑–¥–∞–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å ${remoteUserId}`);
        
        const configuration = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' },
                { urls: 'stun:stun2.l.google.com:19302' },
                { urls: 'stun:stun3.l.google.com:19302' },
                { urls: 'stun:stun4.l.google.com:19302' }
            ],
            iceCandidatePoolSize: 10,
            bundlePolicy: 'max-bundle',
            rtcpMuxPolicy: 'require'
        };
        
        const pc = new RTCPeerConnection(configuration);
        peerConnections[remoteUserId] = pc;
        
        // –î–æ–±–∞–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–∫–∏
        if (localStream) {
            localStream.getTracks().forEach(track => {
                pc.addTrack(track, localStream);
            });
            log(`–î–æ–±–∞–≤–ª–µ–Ω—ã –ª–æ–∫–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–∫–∏ –¥–ª—è ${remoteUserId}`);
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        pc.onicecandidate = (event) => {
            if (event.candidate) {
                sendSignalingMessage({
                    type: 'ice-candidate',
                    from: userId,
                    to: remoteUserId,
                    payload: event.candidate
                });
            }
        };
        
        pc.ontrack = (event) => {
            log(`–ü–æ–ª—É—á–µ–Ω —É–¥–∞–ª–µ–Ω–Ω—ã–π –ø–æ—Ç–æ–∫ –æ—Ç ${remoteUserId}`);
            handleRemoteStream(event.streams[0], remoteUserId);
        };
        
        pc.oniceconnectionstatechange = () => {
            log(`ICE —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å ${remoteUserId}: ${pc.iceConnectionState}`);
            
            if (pc.iceConnectionState === 'failed' || 
                pc.iceConnectionState === 'disconnected') {
                log(`–ü—Ä–æ–±–ª–µ–º–∞ —Å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ–º ${remoteUserId}`, 'warning');
            }
        };
        
        pc.onicegatheringstatechange = () => {
            log(`ICE —Å–±–æ—Ä —Å ${remoteUserId}: ${pc.iceGatheringState}`);
        };
        
        pc.onsignalingstatechange = () => {
            log(`–°–∏–≥–Ω–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å ${remoteUserId}: ${pc.signalingState}`);
        };
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–∂–∏–¥–∞—é—â–∏—Ö ICE –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤
        if (iceCandidatesQueue[remoteUserId]) {
            iceCandidatesQueue[remoteUserId].forEach(candidate => {
                pc.addIceCandidate(new RTCIceCandidate(candidate));
            });
            delete iceCandidatesQueue[remoteUserId];
        }
        
        return pc;
        
    } catch (error) {
        log(`–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è PeerConnection: ${error.message}`, 'error');
        throw error;
    }
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
async function handleOffer(from, offer) {
    try {
        log(`–û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –æ—Ç ${from}`);
        
        let pc = peerConnections[from];
        if (!pc) {
            pc = createPeerConnection(from);
        }
        
        await pc.setRemoteDescription(new RTCSessionDescription(offer));
        log(`–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ —É–¥–∞–ª–µ–Ω–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –æ—Ç ${from}`);
        
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        log(`–°–æ–∑–¥–∞–Ω –æ—Ç–≤–µ—Ç –¥–ª—è ${from}`);
        
        sendSignalingMessage({
            type: 'answer',
            from: userId,
            to: from,
            payload: answer
        });
        
    } catch (error) {
        log(`–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è: ${error.message}`, 'error');
    }
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–∞
async function handleAnswer(from, answer) {
    try {
        const pc = peerConnections[from];
        if (pc && pc.signalingState !== 'stable') {
            await pc.setRemoteDescription(new RTCSessionDescription(answer));
            log(`–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –æ—Ç–≤–µ—Ç –æ—Ç ${from}`);
        }
    } catch (error) {
        log(`–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—Ç–≤–µ—Ç–∞: ${error.message}`, 'error');
    }
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ ICE –∫–∞–Ω–¥–∏–¥–∞—Ç–∞
async function handleIceCandidate(from, candidate) {
    try {
        const pc = peerConnections[from];
        if (pc && pc.remoteDescription) {
            await pc.addIceCandidate(new RTCIceCandidate(candidate));
            log(`–î–æ–±–∞–≤–ª–µ–Ω ICE –∫–∞–Ω–¥–∏–¥–∞—Ç –æ—Ç ${from}`);
        } else {
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ –≤ –æ—á–µ—Ä–µ–¥—å
            if (!iceCandidatesQueue[from]) {
                iceCandidatesQueue[from] = [];
            }
            iceCandidatesQueue[from].push(candidate);
            log(`ICE –∫–∞–Ω–¥–∏–¥–∞—Ç –æ—Ç ${from} —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ –æ—á–µ—Ä–µ–¥—å`);
        }
    } catch (error) {
        log(`–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è ICE –∫–∞–Ω–¥–∏–¥–∞—Ç–∞: ${error.message}`, 'error');
    }
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–æ–≤–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞
async function handleNewParticipant(participantId) {
    if (participantId === userId) return;
    
    log(`–ò–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å –Ω–æ–≤—ã–º —É—á–∞—Å—Ç–Ω–∏–∫–æ–º: ${participantId}`);
    
    try {
        const pc = createPeerConnection(participantId);
        
        // –°–æ–∑–¥–∞–µ–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ
        const offer = await pc.createOffer({
            offerToReceiveAudio: true,
            offerToReceiveVideo: false
        });
        
        await pc.setLocalDescription(offer);
        log(`–°–æ–∑–¥–∞–Ω–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è ${participantId}`);
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ
        sendSignalingMessage({
            type: 'offer',
            from: userId,
            to: participantId,
            payload: offer
        });
        
    } catch (error) {
        log(`–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ ${participantId}: ${error.message}`, 'error');
    }
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã—Ö–æ–¥–∞ —É—á–∞—Å—Ç–Ω–∏–∫–∞
function handleParticipantLeft(participantId) {
    if (peerConnections[participantId]) {
        peerConnections[participantId].close();
        delete peerConnections[participantId];
        log(`–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å ${participantId} –∑–∞–∫—Ä—ã—Ç–æ`);
    }
    
    // –£–¥–∞–ª—è–µ–º –∞—É–¥–∏–æ —ç–ª–µ–º–µ–Ω—Ç –µ—Å–ª–∏ –µ—Å—Ç—å
    const audioElement = document.getElementById(`audio-${participantId}`);
    if (audioElement) {
        audioElement.remove();
    }
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ –ø–æ—Ç–æ–∫–∞
function handleRemoteStream(stream, remoteUserId) {
    try {
        // –°–æ–∑–¥–∞–µ–º —Å–∫—Ä—ã—Ç—ã–π –∞—É–¥–∏–æ —ç–ª–µ–º–µ–Ω—Ç
        const audio = document.createElement('audio');
        audio.id = `audio-${remoteUserId}`;
        audio.autoplay = true;
        audio.style.display = 'none';
        audio.volume = 1.0;
        
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º AudioContext –¥–ª—è –ª—É—á—à–µ–≥–æ –∫–æ–Ω—Ç—Ä–æ–ª—è
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const source = audioContext.createMediaStreamSource(stream);
        const destination = audioContext.createMediaStreamDestination();
        
        source.connect(destination);
        audio.srcObject = destination.stream;
        
        document.body.appendChild(audio);
        log(`–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∞—É–¥–∏–æ –æ—Ç ${remoteUserId}`);
        
    } catch (error) {
        log(`–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ –ø–æ—Ç–æ–∫–∞: ${error.message}`, 'error');
    }
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
async function fetchParticipants() {
    try {
        const result = await apiCall(`/room/${roomId}/participants`);
        
        if (result.success && result.participants) {
            const otherParticipants = result.participants.filter(p => p.id !== userId);
            
            otherParticipants.forEach(participant => {
                if (!peerConnections[participant.id]) {
                    handleNewParticipant(participant.id);
                }
            });
            
            log(`–í –∫–æ–º–Ω–∞—Ç–µ ${otherParticipants.length} –¥—Ä—É–≥–∏—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤`);
        }
    } catch (error) {
        log(`–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤: ${error.message}`, 'error');
    }
}

// –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ
async function cleanup() {
    log('–û—á–∏—Å—Ç–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤...');
    
    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ PeerConnections
    Object.values(peerConnections).forEach(pc => {
        pc.close();
    });
    peerConnections = {};
    
    // –ó–∞–∫—Ä—ã–≤–∞–µ–º WebSocket
    if (signalingChannel) {
        signalingChannel.close();
        signalingChannel = null;
    }
    
    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫
    if (localStream) {
        localStream.getTracks().forEach(track => track.stop());
        localStream = null;
    }
    
    // –£–≤–µ–¥–æ–º–ª—è–µ–º —Å–µ—Ä–≤–µ—Ä –æ –≤—ã—Ö–æ–¥–µ
    if (roomId && userId) {
        try {
            await apiCall(`/room/${roomId}/leave`, 'POST', { userId });
        } catch (error) {
            // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ
        }
    }
    
    roomId = null;
    updateStatus('–û—Ç–∫–ª—é—á–µ–Ω–æ', 'disconnected');
    document.getElementById('roomIdDisplay').textContent = '–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ';
    
    log('–†–µ—Å—É—Ä—Å—ã –æ—á–∏—â–µ–Ω—ã');
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã
window.addEventListener('beforeunload', async (event) => {
    await cleanup();
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–∏–¥–∏–º–æ—Å—Ç–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
        log('–°—Ç—Ä–∞–Ω–∏—Ü–∞ —Å–∫—Ä—ã—Ç–∞', 'warning');
    } else {
        log('–°—Ç—Ä–∞–Ω–∏—Ü–∞ –≤–∏–¥–Ω–∞');
    }
});

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
log('–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ');
updateStatus('–ì–æ—Ç–æ–≤–æ', 'disconnected');
</script>
</body>
</html>
