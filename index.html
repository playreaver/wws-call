<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WWS Audio Call - –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0c2461, #1e3799);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }
        .header { 
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
        }
        .header h1 { 
            font-size: 28px;
            margin-bottom: 10px;
            color: #4bcffa;
        }
        .status-card {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 5px solid #0be881;
        }
        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .control-box {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
        }
        .btn {
            background: linear-gradient(45deg, #3c40c6, #575fcf);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            margin: 10px 0;
            width: 100%;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(60, 64, 198, 0.3);
        }
        .btn:active { transform: translateY(0); }
        .btn-success { background: linear-gradient(45deg, #05c46b, #0be881); }
        .btn-warning { background: linear-gradient(45deg, #ffa801, #ffd32a); }
        .btn-danger { background: linear-gradient(45deg, #ff3f34, #ff5e57); }
        input {
            width: 100%;
            padding: 12px;
            border-radius: 10px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            background: rgba(0, 0, 0, 0.3);
            color: white;
            font-size: 16px;
            margin: 10px 0;
        }
        .log {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
        }
        .log-item {
            margin-bottom: 8px;
            padding-left: 10px;
            border-left: 3px solid;
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }
        .room-display {
            background: rgba(75, 207, 250, 0.1);
            border: 2px dashed #4bcffa;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            margin: 20px 0;
            display: none;
        }
        .room-id {
            font-size: 32px;
            font-weight: bold;
            letter-spacing: 3px;
            color: #0be881;
            font-family: monospace;
            margin: 10px 0;
        }
        .loading { display: none; }
        .loading.active {
            display: inline-block;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéß WWS Audio Call v2.0</h1>
            <p>–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è —Å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º</p>
        </div>
        
        <div class="status-card">
            <h3>üìä –°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã</h3>
            <p>API: <span id="api-status">üî¥ –ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω</span></p>
            <p>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: <span id="user-id">-</span></p>
            <p>–ö–æ–º–Ω–∞—Ç–∞: <span id="room-status">–ù–µ –≤—ã–±—Ä–∞–Ω–∞</span></p>
        </div>
        
        <div class="controls">
            <div class="control-box">
                <h3>üåê –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ</h3>
                <button class="btn" onclick="ping()">
                    <span class="loading" id="ping-loading">‚ü≥</span>
                    –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
                </button>
                <button class="btn btn-success" onclick="createRoom()">
                    <span class="loading" id="create-loading">‚ü≥</span>
                    –°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É
                </button>
            </div>
            
            <div class="control-box">
                <h3>üö™ –í—Ö–æ–¥ –≤ –∫–æ–º–Ω–∞—Ç—É</h3>
                <input type="text" id="room-input" placeholder="–í–≤–µ–¥–∏—Ç–µ ID –∫–æ–º–Ω–∞—Ç—ã (6 —Å–∏–º–≤–æ–ª–æ–≤)" maxlength="6">
                <button class="btn" onclick="joinRoom()">
                    <span class="loading" id="join-loading">‚ü≥</span>
                    –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è
                </button>
            </div>
        </div>
        
        <div class="room-display" id="room-display">
            <h3>üé§ –ê–∫—Ç–∏–≤–Ω–∞—è –∫–æ–º–Ω–∞—Ç–∞</h3>
            <div class="room-id" id="room-id">-</div>
            <button class="btn btn-warning" onclick="copyRoomId()">üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å ID</button>
        </div>
        
        <div class="control-box">
            <h3>‚ö° –ë—ã—Å—Ç—Ä—ã–µ –∫–æ–º–∞–Ω–¥—ã</h3>
            <button class="btn" onclick="testAll()">üîç –ü–æ–ª–Ω—ã–π —Ç–µ—Å—Ç</button>
            <button class="btn btn-danger" onclick="clearLog()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥</button>
        </div>
        
        <div class="log" id="log"></div>
    </div>

    <script>
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
        const API_URL = "https://functions.yandexcloud.net/d4etraj6pl3ep8uj8cd8";
        const userId = generateUserId();
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('user-id').textContent = userId;
            log('üü° –°–∏—Å—Ç–µ–º–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞', 'info');
            log(`üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${userId}`, 'info');
            
            // –ê–≤—Ç–æ–ø–∏–Ω–≥ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
            setTimeout(() => ping(), 500);
        });
        
        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function generateUserId() {
            const prefix = 'user_';
            const timestamp = Date.now().toString(36);
            const random = Math.random().toString(36).substr(2, 4);
            return prefix + timestamp + random;
        }
        
        // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
        function log(message, type = 'info') {
            const logEl = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            const colors = {
                'info': '#4bcffa',
                'success': '#0be881',
                'warning': '#ffa801',
                'error': '#ff3f34'
            };
            
            const item = document.createElement('div');
            item.className = 'log-item';
            item.innerHTML = `<span style="color:#777">[${time}]</span> <span style="color:${colors[type]}">${message}</span>`;
            logEl.appendChild(item);
            logEl.scrollTop = logEl.scrollHeight;
        }
        
        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∞–º–∏
        function setLoading(buttonId, isLoading) {
            const loadingEl = document.getElementById(buttonId);
            loadingEl.classList.toggle('active', isLoading);
        }
        
        // Ping –∑–∞–ø—Ä–æ—Å
        async function ping() {
            setLoading('ping-loading', true);
            log('üîÑ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å API...', 'info');
            
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'ping' })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('api-status').innerHTML = 'üü¢ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ';
                    document.getElementById('api-status').style.color = '#0be881';
                    log(`‚úÖ ${data.message} | ${new Date(data.timestamp).toLocaleTimeString()}`, 'success');
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                document.getElementById('api-status').innerHTML = 'üî¥ –û—à–∏–±–∫–∞';
                document.getElementById('api-status').style.color = '#ff3f34';
                log(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ${error.message}`, 'error');
            } finally {
                setLoading('ping-loading', false);
            }
        }
        
        // –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã
        async function createRoom() {
            setLoading('create-loading', true);
            log('üîÑ –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –∫–æ–º–Ω–∞—Ç—ã...', 'info');
            
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'createRoom',
                        userId: userId
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showRoom(data.roomId);
                    log(`‚úÖ –ö–æ–º–Ω–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∞: ${data.roomId}`, 'success');
                    
                    // –ê–≤—Ç–æ–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –±—É—Ñ–µ—Ä
                    copyToClipboard(data.roomId);
                    log('üìã ID –∫–æ–º–Ω–∞—Ç—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä', 'info');
                    
                    // –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω
                    setTimeout(() => {
                        if (confirm('–•–æ—Ç–∏—Ç–µ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º —Ä–∞–∑–≥–æ–≤–æ—Ä–∞?')) {
                            testMicrophone();
                        }
                    }, 500);
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–º–Ω–∞—Ç—ã: ${error.message}`, 'error');
            } finally {
                setLoading('create-loading', false);
            }
        }
        
        // –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∫ –∫–æ–º–Ω–∞—Ç–µ
        async function joinRoom() {
            const roomId = document.getElementById('room-input').value.trim().toUpperCase();
            
            if (!roomId || roomId.length !== 6) {
                log('‚ùå ID –∫–æ–º–Ω–∞—Ç—ã –¥–æ–ª–∂–µ–Ω —Å–æ—Å—Ç–æ—è—Ç—å –∏–∑ 6 —Å–∏–º–≤–æ–ª–æ–≤', 'error');
                return;
            }
            
            setLoading('join-loading', true);
            log(`üîÑ –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∫ –∫–æ–º–Ω–∞—Ç–µ ${roomId}...`, 'info');
            
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'joinRoom',
                        roomId: roomId,
                        userId: userId
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showRoom(roomId);
                    log(`‚úÖ –£—Å–ø–µ—à–Ω–æ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª–∏—Å—å –∫ –∫–æ–º–Ω–∞—Ç–µ ${roomId}`, 'success');
                    log(`üë• –£—á–∞—Å—Ç–Ω–∏–∫: ${JSON.stringify(data.participant)}`, 'info');
                    
                    // –¢–µ—Å—Ç –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
                    setTimeout(() => testMicrophone(), 300);
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: ${error.message}`, 'error');
            } finally {
                setLoading('join-loading', false);
            }
        }
        
        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã
        function showRoom(roomId) {
            document.getElementById('room-status').textContent = roomId;
            document.getElementById('room-status').style.color = '#0be881';
            document.getElementById('room-id').textContent = roomId;
            document.getElementById('room-display').style.display = 'block';
        }
        
        // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –±—É—Ñ–µ—Ä
        async function copyToClipboard(text) {
            try {
                await navigator.clipboard.writeText(text);
                return true;
            } catch (err) {
                // Fallback –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                return true;
            }
        }
        
        // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ ID –∫–æ–º–Ω–∞—Ç—ã
        async function copyRoomId() {
            const roomId = document.getElementById('room-id').textContent;
            if (roomId !== '-') {
                await copyToClipboard(roomId);
                log('üìã ID –∫–æ–º–Ω–∞—Ç—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä', 'success');
                
                // –í–∏–∑—É–∞–ª—å–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å
                const roomEl = document.getElementById('room-id');
                const original = roomEl.textContent;
                roomEl.textContent = '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
                roomEl.style.color = '#ffa801';
                
                setTimeout(() => {
                    roomEl.textContent = original;
                    roomEl.style.color = '#0be881';
                }, 1000);
            }
        }
        
        // –¢–µ—Å—Ç –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
        async function testMicrophone() {
            log('üé§ –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É...', 'info');
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    }
                });
                
                log('‚úÖ –ú–∏–∫—Ä–æ—Ñ–æ–Ω –¥–æ—Å—Ç—É–ø–µ–Ω', 'success');
                
                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç—Ä–∏–º –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏
                stream.getTracks().forEach(track => track.stop());
                
                return true;
            } catch (error) {
                log('‚ùå –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É', 'error');
                return false;
            }
        }
        
        // –ü–æ–ª–Ω—ã–π —Ç–µ—Å—Ç
        async function testAll() {
            log('üöÄ –ó–∞–ø—É—Å–∫ –ø–æ–ª–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞ —Å–∏—Å—Ç–µ–º—ã...', 'warning');
            
            await ping();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            if (document.getElementById('api-status').textContent.includes('–ü–æ–¥–∫–ª—é—á–µ–Ω–æ')) {
                await createRoom();
            }
        }
        
        // –û—á–∏—Å—Ç–∫–∞ –ª–æ–≥–∞
        function clearLog() {
            document.getElementById('log').innerHTML = '';
            log('üóëÔ∏è –õ–æ–≥ –æ—á–∏—â–µ–Ω', 'warning');
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–≤–æ–¥–∞
        document.getElementById('room-input').addEventListener('input', function(e) {
            this.value = this.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
        });
        
        // –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'Enter') {
                joinRoom();
            }
            if (e.key === 'F5') {
                e.preventDefault();
                ping();
            }
        });
    </script>
</body>
</html>
