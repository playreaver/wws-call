<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéß WWS Audio Call - –ì–æ–ª–æ—Å–æ–≤–æ–π —á–∞—Ç</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #00c6ff, #0072ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .header p {
            color: #a0a0a0;
            font-size: 1.1rem;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
        
        .panel {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .panel h2 {
            color: #00c6ff;
            margin-bottom: 20px;
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .btn {
            background: linear-gradient(45deg, #00c6ff, #0072ff);
            color: white;
            border: none;
            padding: 14px 24px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin: 8px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 198, 255, 0.3);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-success {
            background: linear-gradient(45deg, #00b09b, #96c93d);
        }
        
        .btn-danger {
            background: linear-gradient(45deg, #ff416c, #ff4b2b);
        }
        
        .btn-warning {
            background: linear-gradient(45deg, #f7971e, #ffd200);
        }
        
        .input-group {
            margin: 15px 0;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: #a0a0a0;
            font-size: 14px;
        }
        
        input {
            width: 100%;
            padding: 14px;
            border-radius: 10px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            background: rgba(0, 0, 0, 0.3);
            color: white;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        input:focus {
            outline: none;
            border-color: #00c6ff;
            box-shadow: 0 0 15px rgba(0, 198, 255, 0.2);
        }
        
        .room-display {
            background: linear-gradient(135deg, rgba(0, 198, 255, 0.1), rgba(0, 114, 255, 0.1));
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            margin: 20px 0;
            border: 2px dashed rgba(0, 198, 255, 0.3);
            display: none;
        }
        
        .room-id {
            font-size: 2.5rem;
            font-weight: bold;
            letter-spacing: 5px;
            color: #00ff88;
            font-family: monospace;
            text-shadow: 0 0 20px rgba(0, 255, 136, 0.5);
            margin: 15px 0;
        }
        
        .participants {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .participant-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }
        
        .participant-card.active {
            border-color: #00ff88;
            background: rgba(0, 255, 136, 0.05);
        }
        
        .participant-card .avatar {
            width: 60px;
            height: 60px;
            background: linear-gradient(45deg, #00c6ff, #0072ff);
            border-radius: 50%;
            margin: 0 auto 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
        }
        
        .audio-container {
            grid-column: 1 / -1;
            margin-top: 30px;
        }
        
        .audio-visualizer {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }
        
        @media (max-width: 768px) {
            .audio-visualizer {
                grid-template-columns: 1fr;
            }
        }
        
        .audio-track {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }
        
        .audio-track h3 {
            color: #00c6ff;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .audio-wave {
            height: 100px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            margin: 15px 0;
            position: relative;
            overflow: hidden;
        }
        
        .wave-bar {
            position: absolute;
            bottom: 0;
            width: 4px;
            background: #00ff88;
            border-radius: 2px;
            animation: wave 1.5s ease-in-out infinite;
        }
        
        @keyframes wave {
            0%, 100% { height: 20%; }
            50% { height: 80%; }
        }
        
        .log-container {
            margin-top: 30px;
        }
        
        .log {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 20px;
            height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        
        .log-item {
            padding: 8px 12px;
            margin-bottom: 8px;
            border-radius: 6px;
            border-left: 4px solid;
            background: rgba(255, 255, 255, 0.05);
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        .log-item.info { border-left-color: #00c6ff; }
        .log-item.success { border-left-color: #00ff88; }
        .log-item.warning { border-left-color: #ffd200; }
        .log-item.error { border-left-color: #ff416c; }
        
        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
        }
        
        .status-online {
            background: rgba(0, 255, 136, 0.1);
            color: #00ff88;
        }
        
        .status-offline {
            background: rgba(255, 65, 108, 0.1);
            color: #ff416c;
        }
        
        .status-pulse {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        .status-online .status-pulse {
            background: #00ff88;
            box-shadow: 0 0 10px #00ff88;
        }
        
        .status-offline .status-pulse {
            background: #ff416c;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .controls-row {
            display: flex;
            gap: 15px;
            margin: 20px 0;
        }
        
        .controls-row .btn {
            flex: 1;
        }
        
        .mic-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 20px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            margin: 15px 0;
        }
        
        .mic-level {
            flex: 1;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .mic-level-fill {
            height: 100%;
            background: linear-gradient(90deg, #00c6ff, #0072ff);
            border-radius: 4px;
            transition: width 0.1s ease;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
        <div class="header">
            <h1><i class="fas fa-phone-alt"></i> WWS Audio Call</h1>
            <p>–í—ã—Å–æ–∫–æ–∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –≥–æ–ª–æ—Å–æ–≤–æ–π —á–∞—Ç –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏</p>
        </div>
        
        <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
        <div class="main-content">
            <!-- –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ -->
            <div class="panel">
                <h2><i class="fas fa-cogs"></i> –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h2>
                
                <div class="status-indicator" id="connectionStatus">
                    <div class="status-pulse"></div>
                    <span>–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</span>
                </div>
                
                <div class="input-group">
                    <label for="userId">–í–∞—à ID:</label>
                    <input type="text" id="userId" readonly>
                </div>
                
                <button class="btn btn-success" onclick="createRoom()">
                    <i class="fas fa-plus-circle"></i> –°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É
                </button>
                
                <div class="input-group">
                    <label for="roomInput"><i class="fas fa-door-open"></i> ID –∫–æ–º–Ω–∞—Ç—ã:</label>
                    <input type="text" id="roomInput" placeholder="–í–≤–µ–¥–∏—Ç–µ 6 —Å–∏–º–≤–æ–ª–æ–≤" maxlength="6">
                </div>
                
                <button class="btn" onclick="joinRoom()">
                    <i class="fas fa-sign-in-alt"></i> –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è
                </button>
                
                <div class="mic-indicator">
                    <i class="fas fa-microphone"></i>
                    <div class="mic-level">
                        <div class="mic-level-fill" id="micLevel"></div>
                    </div>
                    <span id="micStatus">–í—ã–∫–ª.</span>
                </div>
                
                <div class="controls-row">
                    <button class="btn btn-warning" onclick="toggleMic()" id="micButton">
                        <i class="fas fa-microphone"></i> –í–∫–ª. –º–∏–∫—Ä–æ—Ñ–æ–Ω
                    </button>
                    <button class="btn" onclick="toggleAudio()" id="audioButton">
                        <i class="fas fa-volume-up"></i> –í–∫–ª. –∑–≤—É–∫
                    </button>
                </div>
                
                <button class="btn btn-danger" onclick="leaveRoom()" id="leaveButton" style="display: none;">
                    <i class="fas fa-sign-out-alt"></i> –ü–æ–∫–∏–Ω—É—Ç—å –∫–æ–º–Ω–∞—Ç—É
                </button>
            </div>
            
            <!-- –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å: –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
            <div class="panel">
                <h2><i class="fas fa-info-circle"></i> –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h2>
                
                <div id="roomInfo" style="display: none;">
                    <h3>–¢–µ–∫—É—â–∞—è –∫–æ–º–Ω–∞—Ç–∞:</h3>
                    <div class="room-id" id="currentRoomId">-</div>
                    <button class="btn" onclick="copyRoomId()" style="margin: 15px 0;">
                        <i class="fas fa-copy"></i> –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å ID
                    </button>
                    
                    <h3 style="margin-top: 20px;">–£—á–∞—Å—Ç–Ω–∏–∫–∏ (<span id="participantCount">0</span>):</h3>
                    <div class="participants" id="participantsList">
                        <!-- –£—á–∞—Å—Ç–Ω–∏–∫–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –∑–¥–µ—Å—å -->
                    </div>
                </div>
                
                <div id="noRoomInfo">
                    <p style="color: #a0a0a0; text-align: center; padding: 40px 20px;">
                        <i class="fas fa-door-closed fa-3x" style="margin-bottom: 20px; opacity: 0.5;"></i><br>
                        –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç–µ—Å—å –∫ –∫–æ–º–Ω–∞—Ç–µ, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –æ–±—â–µ–Ω–∏–µ
                    </p>
                </div>
            </div>
        </div>
        
        <!-- –ê—É–¥–∏–æ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ç–æ—Ä -->
        <div class="audio-container panel">
            <h2><i class="fas fa-wave-square"></i> –ê—É–¥–∏–æ</h2>
            <div class="audio-visualizer">
                <div class="audio-track">
                    <h3><i class="fas fa-user"></i> –í–∞—à –º–∏–∫—Ä–æ—Ñ–æ–Ω</h3>
                    <div class="audio-wave" id="localAudioWave">
                        <!-- –í–æ–ª–Ω—ã –±—É–¥—É—Ç –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è JS -->
                    </div>
                    <p id="localAudioStatus">–ù–µ –∞–∫—Ç–∏–≤–µ–Ω</p>
                </div>
                <div class="audio-track">
                    <h3><i class="fas fa-users"></i> –£–¥–∞–ª–µ–Ω–Ω—ã–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏</h3>
                    <div class="audio-wave" id="remoteAudioWave">
                        <!-- –í–æ–ª–Ω—ã –±—É–¥—É—Ç –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è JS -->
                    </div>
                    <p id="remoteAudioStatus">–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π</p>
                </div>
            </div>
        </div>
        
        <!-- –õ–æ–≥ —Å–æ–±—ã—Ç–∏–π -->
        <div class="log-container panel">
            <h2><i class="fas fa-terminal"></i> –õ–æ–≥ —Å–æ–±—ã—Ç–∏–π</h2>
            <div class="log" id="log"></div>
            <button class="btn" onclick="clearLog()" style="margin-top: 15px;">
                <i class="fas fa-trash"></i> –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥
            </button>
        </div>
    </div>

    <!-- –°–∫—Ä—ã—Ç—ã–µ –∞—É–¥–∏–æ —ç–ª–µ–º–µ–Ω—Ç—ã -->
    <audio id="remoteAudio" autoplay></audio>

    <script>
// –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
const API_URL = "https://functions.yandexcloud.net/d4etraj6pl3ep8uj8cd8";
const FIREBASE_DB_URL = "https://wws-id-default-rtdb.europe-west1.firebasedatabase.app";

// WebRTC Configuration
const configuration = {
    iceServers: [
        { urls: 'stun:stun.l.google.com:19302' },
        { urls: 'stun:stun1.l.google.com:19302' },
        { urls: 'stun:stun2.l.google.com:19302' },
        { urls: 'stun:stun3.l.google.com:19302' },
        { urls: 'stun:stun4.l.google.com:19302' },
        { 
            urls: 'turn:openrelay.metered.ca:80',
            username: 'openrelayproject',
            credential: 'openrelayproject'
        },
        {
            urls: 'turn:openrelay.metered.ca:443',
            username: 'openrelayproject',
            credential: 'openrelayproject'
        },
        {
            urls: 'turn:openrelay.metered.ca:443?transport=tcp',
            username: 'openrelayproject',
            credential: 'openrelayproject'
        }
    ],
    iceCandidatePoolSize: 10,
    iceTransportPolicy: 'all',
    bundlePolicy: 'max-bundle',
    rtcpMuxPolicy: 'require'
};

// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
let userId = generateUserId();
let currentRoomId = null;
let localStream = null;
let peerConnections = {};
let isMicMuted = true;
let isAudioMuted = false;
let audioContext = null;
let analyser = null;
let dataArray = null;
let signalInterval = null;
let participantsInterval = null;

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('userId').value = userId;
    updateStatus('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...', 'offline');
    log('üöÄ –°–∏—Å—Ç–µ–º–∞ –∑–∞–ø—É—â–µ–Ω–∞', 'info');
    log(`üë§ –í–∞—à ID: ${userId}`, 'info');
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ WebRTC
    if (!checkWebRTCSupport()) {
        showWebRTCWarning();
        return;
    }
    
    // –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
    testConnection();
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞—É–¥–∏–æ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ç–æ—Ä–∞
    initAudioVisualizer();
    
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≥–æ—Ä—è—á–∏—Ö –∫–ª–∞–≤–∏—à
    setupKeyboardShortcuts();
});

// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
function generateUserId() {
    const colors = ['–°–∏–Ω–∏–π', '–ö—Ä–∞—Å–Ω—ã–π', '–ó–µ–ª–µ–Ω—ã–π', '–ñ–µ–ª—Ç—ã–π', '–§–∏–æ–ª–µ—Ç–æ–≤—ã–π', '–û—Ä–∞–Ω–∂–µ–≤—ã–π'];
    const animals = ['–¢–∏–≥—Ä', '–û—Ä–µ–ª', '–î–µ–ª—å—Ñ–∏–Ω', '–í–æ–ª–∫', '–§–µ–Ω–∏–∫—Å', '–ï–¥–∏–Ω–æ—Ä–æ–≥', '–õ–µ–≤', '–°–æ–≤–∞'];
    const color = colors[Math.floor(Math.random() * colors.length)];
    const animal = animals[Math.floor(Math.random() * animals.length)];
    const num = Math.floor(Math.random() * 90) + 10;
    return `${color}${animal}${num}`;
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ WebRTC
function checkWebRTCSupport() {
    const requiredAPIs = [
        'RTCPeerConnection',
        'RTCSessionDescription',
        'RTCIceCandidate',
        'navigator.mediaDevices',
        'navigator.mediaDevices.getUserMedia'
    ];
    
    for (const api of requiredAPIs) {
        try {
            if (eval(`typeof ${api}`) === 'undefined') {
                log(`‚ùå –ù–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è: ${api}`, 'error');
                return false;
            }
        } catch (e) {
            log(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ ${api}: ${e.message}`, 'error');
            return false;
        }
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö
    if (/Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
        log('üì± –ú–æ–±–∏–ª—å–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ', 'warning');
    }
    
    return true;
}

function showWebRTCWarning() {
    const warning = `
        <div style="
            background: linear-gradient(45deg, #ff416c, #ff4b2b);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        ">
            <h3><i class="fas fa-exclamation-triangle"></i> WebRTC –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è</h3>
            <p>–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≥–æ–ª–æ—Å–æ–≤—ã–µ –∑–≤–æ–Ω–∫–∏.</p>
            <p>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ:</p>
            <ul style="list-style: none; padding: 0;">
                <li>‚úÖ Chrome 72+</li>
                <li>‚úÖ Firefox 68+</li>
                <li>‚úÖ Edge 79+</li>
                <li>‚úÖ Safari 14.1+</li>
            </ul>
        </div>
    `;
    
    document.querySelector('.container').insertAdjacentHTML('afterbegin', warning);
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
function updateStatus(message, type = 'online') {
    const statusEl = document.getElementById('connectionStatus');
    statusEl.className = `status-indicator status-${type}`;
    statusEl.querySelector('span').textContent = message;
}

// –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
function log(message, type = 'info') {
    const logEl = document.getElementById('log');
    const time = new Date().toLocaleTimeString();
    
    const item = document.createElement('div');
    item.className = `log-item ${type}`;
    item.innerHTML = `<span style="color:#777">[${time}]</span> ${message}`;
    
    logEl.appendChild(item);
    
    // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –≤ –ª–æ–≥–µ
    if (logEl.children.length > 50) {
        logEl.removeChild(logEl.firstChild);
    }
    
    logEl.scrollTop = logEl.scrollHeight;
}

function clearLog() {
    document.getElementById('log').innerHTML = '';
    log('–õ–æ–≥ –æ—á–∏—â–µ–Ω', 'warning');
}

// –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É
async function testConnection() {
    try {
        const response = await fetch(API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'ping', userId })
        });
        
        const data = await response.json();
        
        if (data.success) {
            updateStatus('‚úÖ –°–µ—Ä–≤–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω', 'online');
            log('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å —Å–µ—Ä–≤–µ—Ä–æ–º —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ', 'success');
            return true;
        } else {
            throw new Error(data.error);
        }
    } catch (error) {
        updateStatus('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è', 'offline');
        log(`–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É: ${error.message}`, 'error');
        return false;
    }
}

// –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã
async function createRoom() {
    if (!await testConnection()) {
        alert('–°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.');
        return;
    }
    
    log('–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –∫–æ–º–Ω–∞—Ç—ã...', 'info');
    
    try {
        const response = await fetch(API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'createRoom', userId })
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success) {
            currentRoomId = data.roomId;
            showRoomInfo();
            log(`‚úÖ –ö–æ–º–Ω–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∞: ${data.roomId}`, 'success');
            
            // –ö–æ–ø–∏—Ä—É–µ–º ID –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞
            await copyRoomId();
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∞—É–¥–∏–æ
            await initializeAudio();
            
            // –ù–∞—á–∏–Ω–∞–µ–º –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ —Å–∏–≥–Ω–∞–ª–æ–≤
            startSignalPolling();
            
            // –í–∫–ª—é—á–∞–µ–º –º–∏–∫—Ä–æ—Ñ–æ–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            setTimeout(() => toggleMic(), 500);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
            updateParticipantsList();
            
            // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
            startRoomMonitoring();
            
        } else {
            throw new Error(data.error || 'Unknown error');
        }
    } catch (error) {
        log(`–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–º–Ω–∞—Ç—ã: ${error.message}`, 'error');
        alert(`–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–º–Ω–∞—Ç—ã: ${error.message}`);
    }
}

// –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∫ –∫–æ–º–Ω–∞—Ç–µ
async function joinRoom() {
    const roomId = document.getElementById('roomInput').value.trim().toUpperCase();
    
    if (!roomId || roomId.length !== 6) {
        log('‚ùå ID –∫–æ–º–Ω–∞—Ç—ã –¥–æ–ª–∂–µ–Ω —Å–æ—Å—Ç–æ—è—Ç—å –∏–∑ 6 —Å–∏–º–≤–æ–ª–æ–≤', 'error');
        alert('–í–≤–µ–¥–∏—Ç–µ 6-—Å–∏–º–≤–æ–ª—å–Ω—ã–π ID –∫–æ–º–Ω–∞—Ç—ã');
        return;
    }
    
    if (!await testConnection()) {
        alert('–°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.');
        return;
    }
    
    log(`–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∫ –∫–æ–º–Ω–∞—Ç–µ ${roomId}...`, 'info');
    
    try {
        const response = await fetch(API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'joinRoom', roomId, userId })
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success) {
            currentRoomId = roomId;
            showRoomInfo();
            log(`‚úÖ –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª–∏—Å—å –∫ –∫–æ–º–Ω–∞—Ç–µ ${roomId}`, 'success');
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∞—É–¥–∏–æ
            await initializeAudio();
            
            // –ù–∞—á–∏–Ω–∞–µ–º –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ —Å–∏–≥–Ω–∞–ª–æ–≤
            startSignalPolling();
            
            // –í–∫–ª—é—á–∞–µ–º –º–∏–∫—Ä–æ—Ñ–æ–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            setTimeout(() => toggleMic(), 500);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
            updateParticipantsList();
            
            // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
            startRoomMonitoring();
            
            // –°–æ–∑–¥–∞–µ–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
            setTimeout(() => createOffersForExistingParticipants(), 1000);
            
        } else {
            throw new Error(data.error || 'Unknown error');
        }
    } catch (error) {
        log(`–û—à–∏–±–∫–∞ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: ${error.message}`, 'error');
        alert(`–û—à–∏–±–∫–∞ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: ${error.message}`);
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞—É–¥–∏–æ
async function initializeAudio() {
    try {
        // –ü–æ–ª—É—á–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É
        await getLocalStream();
        
        // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é
        setupAudioVisualization();
        
        log('–ê—É–¥–∏–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ', 'success');
    } catch (error) {
        log(`–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∞—É–¥–∏–æ: ${error.message}`, 'error');
    }
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –º–µ–¥–∏–∞–ø–æ—Ç–æ–∫–∞
async function getLocalStream() {
    if (localStream) {
        return localStream;
    }
    
    try {
        log('–ó–∞–ø—Ä–æ—Å –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É...', 'info');
        
        localStream = await navigator.mediaDevices.getUserMedia({
            audio: {
                echoCancellation: true,
                noiseSuppression: true,
                autoGainControl: true,
                channelCount: 2,
                sampleRate: 48000,
                latency: 0.01
            },
            video: false
        });
        
        log('‚úÖ –ú–∏–∫—Ä–æ—Ñ–æ–Ω –¥–æ—Å—Ç—É–ø–µ–Ω', 'success');
        
        // –û–±–Ω–æ–≤–ª—è–µ–º UI
        updateMicUI(false);
        
        return localStream;
        
    } catch (error) {
        log(`‚ùå –û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É: ${error.message}`, 'error');
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é
        showMicrophoneInstructions();
        throw error;
    }
}

function showMicrophoneInstructions() {
    const instructions = `
        <div style="
            background: rgba(255, 200, 0, 0.1);
            border-left: 4px solid #ffd200;
            padding: 15px;
            margin: 15px 0;
            border-radius: 0 10px 10px 0;
        ">
            <h4><i class="fas fa-info-circle"></i> –ö–∞–∫ —Ä–∞–∑—Ä–µ—à–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω:</h4>
            <ul style="margin: 10px 0; padding-left: 20px;">
                <li>–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∏–∫–æ–Ω–∫—É –∫–∞–º–µ—Ä—ã/–º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ –≤ –∞–¥—Ä–µ—Å–Ω–æ–π —Å—Ç—Ä–æ–∫–µ</li>
                <li>–í—ã–±–µ—Ä–∏—Ç–µ "–†–∞–∑—Ä–µ—à–∏—Ç—å" –¥–ª—è —ç—Ç–æ–≥–æ —Å–∞–π—Ç–∞</li>
                <li>–û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É (F5)</li>
            </ul>
        </div>
    `;
    
    document.querySelector('.panel').insertAdjacentHTML('beforeend', instructions);
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
function updateMicUI(isMuted) {
    const micButton = document.getElementById('micButton');
    const micStatus = document.getElementById('micStatus');
    
    if (isMuted) {
        micButton.innerHTML = '<i class="fas fa-microphone-slash"></i> –í–∫–ª. –º–∏–∫—Ä–æ—Ñ–æ–Ω';
        micButton.classList.remove('btn-warning');
        micStatus.textContent = '–í—ã–∫–ª.';
    } else {
        micButton.innerHTML = '<i class="fas fa-microphone"></i> –í—ã–∫–ª. –º–∏–∫—Ä–æ—Ñ–æ–Ω';
        micButton.classList.add('btn-warning');
        micStatus.textContent = '–í–∫–ª.';
    }
}

// –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
async function createOffersForExistingParticipants() {
    if (!currentRoomId) return;
    
    try {
        const response = await fetch(API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                action: 'getParticipants', 
                roomId: currentRoomId, 
                userId 
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            for (const participant of data.participants || []) {
                if (participant.id !== userId) {
                    await createPeerConnection(participant.id);
                }
            }
        }
    } catch (error) {
        console.error('Error getting participants:', error);
    }
}

// –°–æ–∑–¥–∞–Ω–∏–µ Peer Connection
async function createPeerConnection(peerId) {
    // –ï—Å–ª–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –µ–≥–æ
    if (peerConnections[peerId]) {
        return peerConnections[peerId];
    }
    
    log(`–°–æ–∑–¥–∞–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å ${peerId}...`, 'info');
    
    try {
        const pc = new RTCPeerConnection(configuration);
        peerConnections[peerId] = pc;
        
        // –î–æ–±–∞–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–∫–∏
        if (localStream) {
            localStream.getTracks().forEach(track => {
                pc.addTrack(track, localStream);
            });
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ ICE –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤
        pc.onicecandidate = (event) => {
            if (event.candidate) {
                sendSignal(peerId, 'candidate', event.candidate);
            }
        };
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è ICE
        pc.oniceconnectionstatechange = () => {
            log(`ICE —Å ${peerId}: ${pc.iceConnectionState}`, 'info');
            
            if (pc.iceConnectionState === 'connected' || 
                pc.iceConnectionState === 'completed') {
                log(`‚úÖ –ê—É–¥–∏–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å ${peerId} —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ`, 'success');
                updateParticipantsList();
            } else if (pc.iceConnectionState === 'failed' ||
                       pc.iceConnectionState === 'disconnected' ||
                       pc.iceConnectionState === 'closed') {
                log(`‚ùå –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å ${peerId} –ø–æ—Ç–µ—Ä—è–Ω–æ`, 'error');
                cleanupPeerConnection(peerId);
                updateParticipantsList();
            }
        };
        
        // –ü–æ–ª—É—á–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–Ω—ã—Ö —Ç—Ä–µ–∫–æ–≤
        pc.ontrack = (event) => {
            log(`üéß –ü–æ–ª—É—á–µ–Ω –∞—É–¥–∏–æ –ø–æ—Ç–æ–∫ –æ—Ç ${peerId}`, 'success');
            handleRemoteTrack(event, peerId);
        };
        
        // –°–æ–∑–¥–∞–µ–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
        const offer = await pc.createOffer({
            offerToReceiveAudio: true,
            offerToReceiveVideo: false
        });
        
        await pc.setLocalDescription(offer);
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ
        await sendSignal(peerId, 'offer', offer);
        
        log(`üì® –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è ${peerId}`, 'info');
        
        return pc;
        
    } catch (error) {
        log(`–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å ${peerId}: ${error.message}`, 'error');
        cleanupPeerConnection(peerId);
        throw error;
    }
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ —Ç—Ä–µ–∫–∞
function handleRemoteTrack(event, peerId) {
    // –°–æ–∑–¥–∞–µ–º –∏–ª–∏ –ø–æ–ª—É—á–∞–µ–º audio —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è —ç—Ç–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞
    let audioElement = document.getElementById(`audio_${peerId}`);
    
    if (!audioElement) {
        audioElement = document.createElement('audio');
        audioElement.id = `audio_${peerId}`;
        audioElement.autoplay = true;
        audioElement.controls = false;
        audioElement.style.display = 'none';
        audioElement.volume = 1.0;
        document.body.appendChild(audioElement);
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏—è play
        audioElement.onplay = () => {
            log(`üîä –ê—É–¥–∏–æ –æ—Ç ${peerId} –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è`, 'success');
            updateRemoteAudioStatus();
        };
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
        audioElement.onerror = (e) => {
            log(`‚ùå –û—à–∏–±–∫–∞ –∞—É–¥–∏–æ –æ—Ç ${peerId}: ${e.message}`, 'error');
        };
    }
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ—Ç–æ–∫
    audioElement.srcObject = event.streams[0];
}

// –û—á–∏—Å—Ç–∫–∞ Peer Connection
function cleanupPeerConnection(peerId) {
    if (peerConnections[peerId]) {
        peerConnections[peerId].close();
        delete peerConnections[peerId];
    }
    
    // –£–¥–∞–ª—è–µ–º audio —ç–ª–µ–º–µ–Ω—Ç
    const audioElement = document.getElementById(`audio_${peerId}`);
    if (audioElement) {
        audioElement.srcObject = null;
        audioElement.remove();
    }
    
    log(`–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å ${peerId} –æ—á–∏—â–µ–Ω–æ`, 'info');
}

// –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–∏–≥–Ω–∞–ª–∞
async function sendSignal(to, type, data) {
    if (!currentRoomId) return;
    
    try {
        const response = await fetch(API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                action: 'signal',
                roomId: currentRoomId,
                userId: userId,
                signal: { to, type, data }
            })
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        return await response.json();
    } catch (error) {
        console.error('Error sending signal:', error);
        log(`–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–∏–≥–Ω–∞–ª–∞: ${error.message}`, 'error');
    }
}

// –ù–∞—á–∞–ª–æ –æ–ø—Ä–æ—Å–∞ —Å–∏–≥–Ω–∞–ª–æ–≤
function startSignalPolling() {
    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∏–Ω—Ç–µ—Ä–≤–∞–ª
    if (signalInterval) {
        clearInterval(signalInterval);
    }
    
    let lastPollTime = Date.now();
    
    // –û–ø—Ä–∞—à–∏–≤–∞–µ–º —Å–∏–≥–Ω–∞–ª—ã –∫–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã
    signalInterval = setInterval(async () => {
        if (!currentRoomId) return;
        
        try {
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    action: 'getSignals', 
                    roomId: currentRoomId,
                    userId,
                    timestamp: lastPollTime
                })
            });
            
            if (response.ok) {
                const data = await response.json();
                
                if (data.success && data.signals) {
                    // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–ø—Ä–æ—Å–∞
                    lastPollTime = data.timestamp || Date.now();
                    
                    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–∏–≥–Ω–∞–ª—ã
                    for (const signal of data.signals) {
                        await handleIncomingSignal(signal);
                    }
                }
            }
        } catch (error) {
            console.error('Error polling signals:', error);
        }
    }, 2000);
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥—è—â–µ–≥–æ —Å–∏–≥–Ω–∞–ª–∞
async function handleIncomingSignal(signal) {
    // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Å–≤–æ–∏ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å–∏–≥–Ω–∞–ª—ã
    if (signal.from === userId) return;
    
    log(`üì° –°–∏–≥–Ω–∞–ª –æ—Ç ${signal.from}: ${signal.type}`, 'info');
    
    try {
        switch (signal.type) {
            case 'offer':
                await handleOffer(signal.from, signal.data);
                break;
                
            case 'answer':
                await handleAnswer(signal.from, signal.data);
                break;
                
            case 'candidate':
                await handleCandidate(signal.from, signal.data);
                break;
                
            default:
                log(`–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø —Å–∏–≥–Ω–∞–ª–∞: ${signal.type}`, 'warning');
        }
    } catch (error) {
        log(`–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–∏–≥–Ω–∞–ª–∞ –æ—Ç ${signal.from}: ${error.message}`, 'error');
    }
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
async function handleOffer(peerId, offer) {
    let pc = peerConnections[peerId];
    
    if (!pc) {
        pc = new RTCPeerConnection(configuration);
        peerConnections[peerId] = pc;
        
        // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        setupPeerConnectionHandlers(pc, peerId);
        
        // –î–æ–±–∞–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–∫–∏
        if (localStream) {
            localStream.getTracks().forEach(track => {
                pc.addTrack(track, localStream);
            });
        }
    }
    
    await pc.setRemoteDescription(new RTCSessionDescription(offer));
    
    const answer = await pc.createAnswer({
        offerToReceiveAudio: true,
        offerToReceiveVideo: false
    });
    
    await pc.setLocalDescription(answer);
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç
    await sendSignal(peerId, 'answer', answer);
    
    log(`üì® –û—Ç–ø—Ä–∞–≤–ª–µ–Ω –æ—Ç–≤–µ—Ç –¥–ª—è ${peerId}`, 'info');
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–∞
async function handleAnswer(peerId, answer) {
    const pc = peerConnections[peerId];
    if (!pc) return;
    
    await pc.setRemoteDescription(new RTCSessionDescription(answer));
    log(`‚úÖ –û—Ç–≤–µ—Ç –æ—Ç ${peerId} –æ–±—Ä–∞–±–æ—Ç–∞–Ω`, 'success');
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ ICE –∫–∞–Ω–¥–∏–¥–∞—Ç–∞
async function handleCandidate(peerId, candidate) {
    const pc = peerConnections[peerId];
    if (!pc) return;
    
    try {
        await pc.addIceCandidate(new RTCIceCandidate(candidate));
    } catch (error) {
        console.error('Error adding ICE candidate:', error);
    }
}

// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ Peer Connection
function setupPeerConnectionHandlers(pc, peerId) {
    // ICE –∫–∞–Ω–¥–∏–¥–∞—Ç—ã
    pc.onicecandidate = (event) => {
        if (event.candidate) {
            sendSignal(peerId, 'candidate', event.candidate);
        }
    };
    
    // –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è ICE
    pc.oniceconnectionstatechange = () => {
        log(`ICE —Å ${peerId}: ${pc.iceConnectionState}`, 'info');
        
        if (pc.iceConnectionState === 'connected' || 
            pc.iceConnectionState === 'completed') {
            log(`‚úÖ –ê—É–¥–∏–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å ${peerId} —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ`, 'success');
            updateParticipantsList();
        } else if (pc.iceConnectionState === 'failed' ||
                   pc.iceConnectionState === 'disconnected' ||
                   pc.iceConnectionState === 'closed') {
            log(`‚ùå –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å ${peerId} –ø–æ—Ç–µ—Ä—è–Ω–æ`, 'error');
            cleanupPeerConnection(peerId);
            updateParticipantsList();
        }
    };
    
    // –ü–æ–ª—É—á–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–Ω—ã—Ö —Ç—Ä–µ–∫–æ–≤
    pc.ontrack = (event) => {
        log(`üéß –ü–æ–ª—É—á–µ–Ω –∞—É–¥–∏–æ –ø–æ—Ç–æ–∫ –æ—Ç ${peerId}`, 'success');
        handleRemoteTrack(event, peerId);
    };
    
    // –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
    pc.onconnectionstatechange = () => {
        log(`–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å ${peerId}: ${pc.connectionState}`, 'info');
    };
    
    // –û—à–∏–±–∫–∏
    pc.onicecandidateerror = (event) => {
        console.error('ICE candidate error:', event);
    };
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
async function updateParticipantsList() {
    if (!currentRoomId) return;
    
    try {
        const response = await fetch(API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                action: 'getParticipants', 
                roomId: currentRoomId, 
                userId 
            })
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success) {
            displayParticipants(data.participants || []);
        }
    } catch (error) {
        console.error('Error updating participants:', error);
    }
}

// –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
function displayParticipants(participants) {
    const participantsList = document.getElementById('participantsList');
    const countEl = document.getElementById('participantCount');
    
    participantsList.innerHTML = '';
    countEl.textContent = participants.length;
    
    // –°–æ—Ä—Ç–∏—Ä—É–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤: —Å–Ω–∞—á–∞–ª–∞ –º—ã, –ø–æ—Ç–æ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ
    const sortedParticipants = [...participants].sort((a, b) => {
        if (a.id === userId) return -1;
        if (b.id === userId) return 1;
        return a.id.localeCompare(b.id);
    });
    
    sortedParticipants.forEach(participant => {
        const isMe = participant.id === userId;
        const isConnected = participant.id === userId || 
                           peerConnections[participant.id]?.iceConnectionState === 'connected';
        
        const card = createParticipantCard(participant, isMe, isConnected);
        participantsList.appendChild(card);
    });
    
    log(`–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤: ${participants.length}`, 'info');
}

// –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ —É—á–∞—Å—Ç–Ω–∏–∫–∞
function createParticipantCard(participant, isMe, isConnected) {
    const card = document.createElement('div');
    card.className = `participant-card ${isConnected ? 'active' : ''}`;
    
    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–æ–≤ –∏ —Ü–≤–µ—Ç–∞
    const { initials, color } = generateAvatarInfo(participant.id);
    
    card.innerHTML = `
        <div class="avatar" style="background: ${color}">${initials}</div>
        <h4>${participant.id}</h4>
        <p>${isMe ? '<i class="fas fa-user"></i> (–í—ã)' : ''}</p>
        <p>
            <small>
                ${isConnected ? '<i class="fas fa-check-circle"></i> –ü–æ–¥–∫–ª—é—á–µ–Ω' : '<i class="fas fa-clock"></i> –û–∂–∏–¥–∞–Ω–∏–µ'}
            </small>
        </p>
        ${!isMe && isConnected ? '<div class="connection-state connected"></div>' : ''}
    `;
    
    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –¥–ª—è —Ç–µ—Å—Ç–∞ –∞—É–¥–∏–æ
    if (!isMe && isConnected) {
        card.style.cursor = 'pointer';
        card.title = '–ö–ª–∏–∫–Ω–∏—Ç–µ –¥–ª—è —Ç–µ—Å—Ç–∞ –∞—É–¥–∏–æ';
        card.onclick = () => testParticipantAudio(participant.id);
    }
    
    return card;
}

// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –¥–ª—è –∞–≤–∞—Ç–∞—Ä–∞
function generateAvatarInfo(userId) {
    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ü–≤–µ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ ID
    let hash = 0;
    for (let i = 0; i < userId.length; i++) {
        hash = userId.charCodeAt(i) + ((hash << 5) - hash);
    }
    
    const hue = hash % 360;
    const color = `hsl(${hue}, 70%, 60%)`;
    
    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∏–Ω–∏—Ü–∏–∞–ª—ã
    const words = userId.replace(/[0-9]/g, '').split(/(?=[A-Z–ê-–Ø])/);
    let initials = '';
    
    if (words.length >= 2) {
        initials = words[0].charAt(0) + words[1].charAt(0);
    } else {
        initials = userId.substring(0, 2).toUpperCase();
    }
    
    return { initials, color };
}

// –¢–µ—Å—Ç –∞—É–¥–∏–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞
function testParticipantAudio(peerId) {
    const audioElement = document.getElementById(`audio_${peerId}`);
    if (audioElement && audioElement.srcObject) {
        log(`–¢–µ—Å—Ç–∏—Ä—É–µ–º –∞—É–¥–∏–æ –æ—Ç ${peerId}...`, 'info');
        
        // –í—Ä–µ–º–µ–Ω–Ω–æ —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º –≥—Ä–æ–º–∫–æ—Å—Ç—å –¥–ª—è —Ç–µ—Å—Ç–∞
        const originalVolume = audioElement.volume;
        audioElement.volume = 1.0;
        
        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –≥—Ä–æ–º–∫–æ—Å—Ç—å —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
        setTimeout(() => {
            audioElement.volume = originalVolume;
        }, 2000);
    }
}

// –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω–æ–º
async function toggleMic() {
    if (!localStream) {
        try {
            await getLocalStream();
        } catch (error) {
            log('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É', 'error');
            return;
        }
    }
    
    isMicMuted = !isMicMuted;
    
    if (localStream) {
        localStream.getAudioTracks().forEach(track => {
            track.enabled = !isMicMuted;
        });
    }
    
    updateMicUI(isMicMuted);
    
    log(`–ú–∏–∫—Ä–æ—Ñ–æ–Ω ${isMicMuted ? '–æ—Ç–∫–ª—é—á–µ–Ω' : '–≤–∫–ª—é—á–µ–Ω'}`, 
        isMicMuted ? 'warning' : 'success');
}

// –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–≤—É–∫–æ–º
function toggleAudio() {
    isAudioMuted = !isAudioMuted;
    
    // –ü—Ä–∏–º–µ–Ω—è–µ–º –∫–æ –≤—Å–µ–º —É–¥–∞–ª–µ–Ω–Ω—ã–º –∞—É–¥–∏–æ —ç–ª–µ–º–µ–Ω—Ç–∞–º
    const remoteAudios = document.querySelectorAll('[id^="audio_"]');
    remoteAudios.forEach(audio => {
        audio.muted = isAudioMuted;
    });
    
    const audioButton = document.getElementById('audioButton');
    
    if (isAudioMuted) {
        audioButton.innerHTML = '<i class="fas fa-volume-mute"></i> –í–∫–ª. –∑–≤—É–∫';
        audioButton.classList.remove('btn-success');
        log('–ó–≤—É–∫ –æ—Ç–∫–ª—é—á–µ–Ω', 'warning');
    } else {
        audioButton.innerHTML = '<i class="fas fa-volume-up"></i> –í—ã–∫–ª. –∑–≤—É–∫';
        audioButton.classList.add('btn-success');
        log('–ó–≤—É–∫ –≤–∫–ª—é—á–µ–Ω', 'success');
    }
}

// –ù–∞—á–∞–ª–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∫–æ–º–Ω–∞—Ç—ã
function startRoomMonitoring() {
    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∏–Ω—Ç–µ—Ä–≤–∞–ª
    if (participantsInterval) {
        clearInterval(participantsInterval);
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
    participantsInterval = setInterval(() => {
        if (currentRoomId) {
            updateParticipantsList();
            updateRemoteAudioStatus();
        }
    }, 5000);
}

// –ü–æ–∫–∏–Ω—É—Ç—å –∫–æ–º–Ω–∞—Ç—É
async function leaveRoom() {
    if (!currentRoomId) return;
    
    log('–ü–æ–∫–∏–¥–∞–µ–º –∫–æ–º–Ω–∞—Ç—É...', 'warning');
    
    try {
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ WebRTC —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
        Object.values(peerConnections).forEach(pc => {
            if (pc) {
                pc.close();
            }
        });
        peerConnections = {};
        
        // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫
        if (localStream) {
            localStream.getTracks().forEach(track => track.stop());
            localStream = null;
        }
        
        // –£–¥–∞–ª—è–µ–º –≤—Å–µ –∞—É–¥–∏–æ —ç–ª–µ–º–µ–Ω—Ç—ã
        document.querySelectorAll('[id^="audio_"]').forEach(el => el.remove());
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        await fetch(API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'leaveRoom', roomId: currentRoomId, userId })
        });
        
        // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã
        if (signalInterval) {
            clearInterval(signalInterval);
            signalInterval = null;
        }
        
        if (participantsInterval) {
            clearInterval(participantsInterval);
            participantsInterval = null;
        }
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º UI
        resetUI();
        
        currentRoomId = null;
        
        log('‚úÖ –í—ã—à–ª–∏ –∏–∑ –∫–æ–º–Ω–∞—Ç—ã', 'success');
        updateStatus('–ù–µ –≤ –∫–æ–º–Ω–∞—Ç–µ', 'offline');
        
    } catch (error) {
        log(`–û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞: ${error.message}`, 'error');
    }
}

// –°–±—Ä–æ—Å UI
function resetUI() {
    document.getElementById('roomInfo').style.display = 'none';
    document.getElementById('noRoomInfo').style.display = 'block';
    document.getElementById('leaveButton').style.display = 'none';
    document.getElementById('roomInput').value = '';
    document.getElementById('participantsList').innerHTML = '';
    document.getElementById('participantCount').textContent = '0';
    document.getElementById('currentRoomId').textContent = '-';
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –º–∏–∫—Ä–æ—Ñ–æ–Ω
    updateMicUI(true);
    isMicMuted = true;
}

// –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–º–Ω–∞—Ç–µ
function showRoomInfo() {
    document.getElementById('roomInfo').style.display = 'block';
    document.getElementById('noRoomInfo').style.display = 'none';
    document.getElementById('leaveButton').style.display = 'block';
    document.getElementById('currentRoomId').textContent = currentRoomId;
    
    updateStatus(`–í –∫–æ–º–Ω–∞—Ç–µ: ${currentRoomId}`, 'online');
}

// –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å ID –∫–æ–º–Ω–∞—Ç—ã
async function copyRoomId() {
    if (!currentRoomId) return;
    
    try {
        await navigator.clipboard.writeText(currentRoomId);
        
        // –í–∏–∑—É–∞–ª—å–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å
        const roomIdEl = document.getElementById('currentRoomId');
        const originalText = roomIdEl.textContent;
        roomIdEl.textContent = '–°–ö–û–ü–ò–†–û–í–ê–ù–û!';
        roomIdEl.style.color = '#00ff88';
        
        log('ID –∫–æ–º–Ω–∞—Ç—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞', 'success');
        
        setTimeout(() => {
            roomIdEl.textContent = originalText;
            roomIdEl.style.color = '#00ff88';
        }, 1000);
    } catch (error) {
        log('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å ID', 'error');
    }
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
async function copyToClipboard(text) {
    try {
        await navigator.clipboard.writeText(text);
        return true;
    } catch (err) {
        const textArea = document.createElement('textarea');
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        return true;
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞—É–¥–∏–æ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ç–æ—Ä–∞
function initAudioVisualizer() {
    createWaveBars('localAudioWave', 40);
    createWaveBars('remoteAudioWave', 40);
}

function createWaveBars(containerId, count) {
    const container = document.getElementById(containerId);
    container.innerHTML = '';
    
    for (let i = 0; i < count; i++) {
        const bar = document.createElement('div');
        bar.className = 'wave-bar';
        bar.style.left = `${(i / count) * 100}%`;
        bar.style.animationDelay = `${i * 0.05}s`;
        container.appendChild(bar);
    }
}

// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –∞—É–¥–∏–æ
function setupAudioVisualization() {
    if (!localStream || !window.AudioContext) return;
    
    if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        analyser = audioContext.createAnalyser();
        
        const source = audioContext.createMediaStreamSource(localStream);
        source.connect(analyser);
        
        analyser.fftSize = 256;
        const bufferLength = analyser.frequencyBinCount;
        dataArray = new Uint8Array(bufferLength);
        
        function updateVisualization() {
            if (!analyser) return;
            
            requestAnimationFrame(updateVisualization);
            
            analyser.getByteFrequencyData(dataArray);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —É—Ä–æ–≤–µ–Ω—å –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
            const avg = dataArray.reduce((a, b) => a + b) / dataArray.length;
            
            const micLevel = document.getElementById('micLevel');
            micLevel.style.width = `${Math.min(avg / 2, 100)}%`;
            
            // –ê–Ω–∏–º–∏—Ä—É–µ–º –≤–æ–ª–Ω—ã
            const bars = document.querySelectorAll('#localAudioWave .wave-bar');
            bars.forEach((bar, i) => {
                const index = Math.floor(i / bars.length * dataArray.length);
                const value = dataArray[index] / 255;
                bar.style.height = `${20 + value * 80}%`;
                bar.style.opacity = 0.3 + value * 0.7;
            });
        }
        
        updateVisualization();
    }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ –∞—É–¥–∏–æ
function updateRemoteAudioStatus() {
    const remoteAudios = document.querySelectorAll('[id^="audio_"]');
    const statusEl = document.getElementById('remoteAudioStatus');
    
    let activeCount = 0;
    
    remoteAudios.forEach(audio => {
        if (audio.srcObject) {
            const tracks = audio.srcObject.getAudioTracks();
            if (tracks.length > 0 && tracks[0].readyState === 'live') {
                activeCount++;
            }
        }
    });
    
    if (activeCount > 0) {
        statusEl.textContent = `–ê–∫—Ç–∏–≤–Ω–æ: ${activeCount} —É—á–∞—Å—Ç–Ω–∏–∫${activeCount === 1 ? '' : '–∞'}`;
        statusEl.style.color = '#00ff88';
        animateRemoteWaves();
    } else {
        statusEl.textContent = '–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π';
        statusEl.style.color = '#ff416c';
    }
}

function animateRemoteWaves() {
    const bars = document.querySelectorAll('#remoteAudioWave .wave-bar');
    
    function animate() {
        bars.forEach(bar => {
            const randomHeight = 20 + Math.random() * 60;
            bar.style.height = `${randomHeight}%`;
            bar.style.opacity = 0.4 + Math.random() * 0.6;
        });
        
        setTimeout(animate, 100 + Math.random() * 200);
    }
    
    animate();
}

// –¢–µ—Å—Ç –∞—É–¥–∏–æ
async function testAudio() {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ 
            audio: true,
            video: false 
        });
        
        const audio = new Audio();
        audio.srcObject = stream;
        audio.play();
        
        log('‚úÖ –¢–µ—Å—Ç –∞—É–¥–∏–æ: –º–∏–∫—Ä–æ—Ñ–æ–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç', 'success');
        
        // –°–æ–∑–¥–∞–µ–º –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é –¥–ª—è —Ç–µ—Å—Ç–∞
        const testContext = new (window.AudioContext || window.webkitAudioContext)();
        const testAnalyser = testContext.createAnalyser();
        const testSource = testContext.createMediaStreamSource(stream);
        testSource.connect(testAnalyser);
        
        // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
        setTimeout(() => {
            stream.getTracks().forEach(track => track.stop());
            testContext.close();
            log('–¢–µ—Å—Ç –∞—É–¥–∏–æ –∑–∞–≤–µ—Ä—à–µ–Ω', 'info');
        }, 5000);
        
    } catch (error) {
        log(`‚ùå –¢–µ—Å—Ç –∞—É–¥–∏–æ –Ω–µ —É–¥–∞–ª—Å—è: ${error.message}`, 'error');
    }
}

// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≥–æ—Ä—è—á–∏—Ö –∫–ª–∞–≤–∏—à
function setupKeyboardShortcuts() {
    document.addEventListener('keydown', (e) => {
        // Ctrl+C –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è ID –∫–æ–º–Ω–∞—Ç—ã
        if (e.ctrlKey && e.key === 'c' && currentRoomId) {
            e.preventDefault();
            copyRoomId();
        }
        
        // Enter –¥–ª—è –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∫ –∫–æ–º–Ω–∞—Ç–µ
        if (e.key === 'Enter' && document.getElementById('roomInput').value) {
            e.preventDefault();
            joinRoom();
        }
        
        // Alt+M –¥–ª—è –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
        if (e.altKey && e.key === 'm') {
            e.preventDefault();
            toggleMic();
        }
        
        // Alt+A –¥–ª—è –∑–≤—É–∫–∞
        if (e.altKey && e.key === 'a') {
            e.preventDefault();
            toggleAudio();
        }
        
        // Escape –¥–ª—è –≤—ã—Ö–æ–¥–∞
        if (e.key === 'Escape' && currentRoomId) {
            e.preventDefault();
            leaveRoom();
        }
        
        // F5 –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
        if (e.key === 'F5') {
            e.preventDefault();
            updateParticipantsList();
        }
    });
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–≤–æ–¥–∞ ID –∫–æ–º–Ω–∞—Ç—ã
    document.getElementById('roomInput').addEventListener('input', function(e) {
        this.value = this.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
    });
}

// –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–∏—Å—Ç–µ–º–µ
function showSystemInfo() {
    const info = {
        userAgent: navigator.userAgent,
        platform: navigator.platform,
        language: navigator.language,
        webRTC: !!window.RTCPeerConnection,
        mediaDevices: !!navigator.mediaDevices,
        getUserMedia: !!navigator.mediaDevices?.getUserMedia,
        currentRoom: currentRoomId,
        peerConnections: Object.keys(peerConnections).length,
        localStream: !!localStream
    };
    
    console.log('System Info:', info);
    log('–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–∏—Å—Ç–µ–º–µ –≤—ã–≤–µ–¥–µ–Ω–∞ –≤ –∫–æ–Ω—Å–æ–ª—å', 'info');
    
    return info;
}

// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –ø–æ—Ç–µ—Ä–µ —Å–µ—Ç–∏
window.addEventListener('online', () => {
    log('–°–µ—Ç–µ–≤–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ', 'success');
    testConnection();
    
    if (currentRoomId) {
        updateParticipantsList();
    }
});

window.addEventListener('offline', () => {
    log('–°–µ—Ç–µ–≤–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä—è–Ω–æ', 'error');
    updateStatus('‚ùå –ù–µ—Ç —Å–µ—Ç–∏', 'offline');
});

// –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
setInterval(() => {
    if (currentRoomId) {
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º heartbeat –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
        fetch(API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'ping', userId })
        }).catch(() => {
            // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –≤ heartbeat
        });
    }
}, 30000);

// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
setInterval(() => {
    if (currentRoomId) {
        const now = Date.now();
        // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –æ—á–∏—Å—Ç–∫–∏ —Å—Ç–∞—Ä—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
    }
}, 60000);

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞
log('‚úÖ –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ', 'success');
    </script>
</body>
</html>
