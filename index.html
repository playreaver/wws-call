<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WWS Audio Call - Test</title>
<style>
body { 
    font-family: Arial, sans-serif; 
    text-align: center; 
    background: #111; 
    color: white; 
    margin: 0;
    padding: 20px;
}
.container {
    max-width: 600px;
    margin: 0 auto;
    padding: 20px;
    background: #222;
    border-radius: 10px;
    box-shadow: 0 0 20px rgba(0,0,0,0.5);
}
button { 
    padding: 12px 24px; 
    margin: 10px; 
    background: #4CAF50;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 16px;
    transition: background 0.3s;
}
button:hover {
    background: #45a049;
}
input { 
    padding: 12px; 
    width: 200px;
    border: 1px solid #444;
    border-radius: 5px;
    background: #333;
    color: white;
}
.log {
    background: #000;
    color: #0f0;
    padding: 10px;
    border-radius: 5px;
    text-align: left;
    max-height: 200px;
    overflow-y: auto;
    font-family: monospace;
    font-size: 12px;
    margin-top: 20px;
}
.status {
    margin: 20px 0;
    padding: 10px;
    background: #333;
    border-radius: 5px;
}
</style>
</head>
<body>

<div class="container">
    <h2>üîß WWS Audio Call - Test</h2>
    
    <div class="status">
        <p>API URL: <code id="apiUrl"></code></p>
        <p>–°—Ç–∞—Ç—É—Å: <span id="statusText">–ü—Ä–æ–≤–µ—Ä–∫–∞...</span></p>
    </div>
    
    <button onclick="testConnection()">üîç –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</button>
    <button onclick="createRoom()">‚ûï –°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É</button>
    
    <br><br>
    
    <input id="roomInput" placeholder="–í–≤–µ–¥–∏—Ç–µ ID –∫–æ–º–Ω–∞—Ç—ã">
    <button onclick="joinRoom()">üö™ –í–æ–π—Ç–∏ –≤ –∫–æ–º–Ω–∞—Ç—É</button>
    
    <div class="log" id="log"></div>
</div>

<script>
const API_URL = "https://functions.yandexcloud.net/d4etraj6pl3ep8uj8cd8";
let userId = 'user_' + Math.random().toString(36).substring(2, 9);

// –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ API URL
document.getElementById('apiUrl').textContent = API_URL;

// –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
function log(message, type = 'info') {
    const logElement = document.getElementById('log');
    const timestamp = new Date().toLocaleTimeString();
    const color = type === 'error' ? '#f00' : type === 'warning' ? '#ff0' : '#0f0';
    logElement.innerHTML += `<span style="color:${color}">[${timestamp}] ${message}</span><br>`;
    logElement.scrollTop = logElement.scrollHeight;
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
function updateStatus(message, isError = false) {
    const statusElement = document.getElementById('statusText');
    statusElement.textContent = message;
    statusElement.style.color = isError ? '#f00' : '#0f0';
}

// –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
async function testConnection() {
    try {
        updateStatus('–¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...');
        log('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º OPTIONS –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ CORS...');
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º OPTIONS –∑–∞–ø—Ä–æ—Å
        const optionsResponse = await fetch(API_URL + '/health', {
            method: 'OPTIONS'
        });
        
        log(`OPTIONS –æ—Ç–≤–µ—Ç: ${optionsResponse.status} ${optionsResponse.statusText}`);
        
        if (!optionsResponse.ok) {
            throw new Error(`OPTIONS failed: ${optionsResponse.status}`);
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º GET –∑–∞–ø—Ä–æ—Å
        log('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º GET –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞...');
        const getResponse = await fetch(API_URL + '/health', {
            method: 'GET'
        });
        
        log(`GET –æ—Ç–≤–µ—Ç: ${getResponse.status} ${getResponse.statusText}`);
        
        if (!getResponse.ok) {
            throw new Error(`GET failed: ${getResponse.status}`);
        }
        
        const data = await getResponse.json();
        log(`–î–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç–∞: ${JSON.stringify(data)}`);
        
        updateStatus('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ!');
        
    } catch (error) {
        log(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ${error.message}`, 'error');
        updateStatus('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è', true);
    }
}

// –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã
async function createRoom() {
    try {
        updateStatus('–°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã...');
        log('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã...');
        
        const response = await fetch(API_URL + '/room', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                userId: userId
            })
        });
        
        log(`–°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞: ${response.status} ${response.statusText}`);
        
        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`HTTP ${response.status}: ${errorText}`);
        }
        
        const data = await response.json();
        log(`–î–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç–∞: ${JSON.stringify(data)}`);
        
        if (data.success && data.roomId) {
            updateStatus(`‚úÖ –ö–æ–º–Ω–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∞: ${data.roomId}`);
            log(`ID –∫–æ–º–Ω–∞—Ç—ã: ${data.roomId}`);
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª–µ –¥–ª—è –≤—Ö–æ–¥–∞
            document.getElementById('roomInput').value = data.roomId;
            
            alert(`–ö–æ–º–Ω–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∞!\nID: ${data.roomId}\n–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å —ç—Ç–∏–º ID —Å –¥—Ä—É–≥–∏–º–∏ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏.`);
        } else {
            throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞');
        }
        
    } catch (error) {
        log(`‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–º–Ω–∞—Ç—ã: ${error.message}`, 'error');
        updateStatus('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–º–Ω–∞—Ç—ã', true);
        alert(`–û—à–∏–±–∫–∞: ${error.message}`);
    }
}

// –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∫ –∫–æ–º–Ω–∞—Ç–µ
async function joinRoom() {
    const roomId = document.getElementById('roomInput').value.trim().toUpperCase();
    
    if (!roomId) {
        alert('–í–≤–µ–¥–∏—Ç–µ ID –∫–æ–º–Ω–∞—Ç—ã');
        return;
    }
    
    if (roomId.length !== 6) {
        alert('ID –∫–æ–º–Ω–∞—Ç—ã –¥–æ–ª–∂–µ–Ω —Å–æ—Å—Ç–æ—è—Ç—å –∏–∑ 6 —Å–∏–º–≤–æ–ª–æ–≤');
        return;
    }
    
    try {
        updateStatus('–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∫ –∫–æ–º–Ω–∞—Ç–µ...');
        log(`–ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–µ–º—Å—è –∫ –∫–æ–º–Ω–∞—Ç–µ ${roomId}...`);
        
        const response = await fetch(API_URL + `/room/${roomId}/join`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                userId: userId
            })
        });
        
        log(`–°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞: ${response.status} ${response.statusText}`);
        
        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`HTTP ${response.status}: ${errorText}`);
        }
        
        const data = await response.json();
        log(`–î–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç–∞: ${JSON.stringify(data)}`);
        
        if (data.success) {
            updateStatus(`‚úÖ –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª–∏—Å—å –∫ –∫–æ–º–Ω–∞—Ç–µ ${roomId}`);
            
            // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: true 
                });
                log('‚úÖ –î–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –ø–æ–ª—É—á–µ–Ω');
                
                // –ó–¥–µ—Å—å –±—É–¥–µ—Ç –ª–æ–≥–∏–∫–∞ WebRTC
                alert('‚úÖ –£—Å–ø–µ—à–Ω–æ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª–∏—Å—å –∫ –∫–æ–º–Ω–∞—Ç–µ!\n\n–ú–∏–∫—Ä–æ—Ñ–æ–Ω –¥–æ—Å—Ç—É–ø–µ–Ω.\n\n–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥: –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –¥—Ä—É–≥–∏–º —É—á–∞—Å—Ç–Ω–∏–∫–∞–º —á–µ—Ä–µ–∑ WebRTC.');
                
            } catch (mediaError) {
                log(`‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É: ${mediaError.message}`, 'warning');
                alert('‚úÖ –£—Å–ø–µ—à–Ω–æ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª–∏—Å—å –∫ –∫–æ–º–Ω–∞—Ç–µ!\n\n‚ö†Ô∏è –î–ª—è –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ –æ–±—â–µ–Ω–∏—è —Ä–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É.');
            }
        } else {
            throw new Error(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
        }
        
    } catch (error) {
        log(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: ${error.message}`, 'error');
        updateStatus('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è', true);
        alert(`–û—à–∏–±–∫–∞: ${error.message}`);
    }
}

// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–µ—Å—Ç –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
window.addEventListener('load', () => {
    log(`–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è... –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${userId}`);
    log(`API URL: ${API_URL}`);
    testConnection();
});
</script>
</body>
</html>
