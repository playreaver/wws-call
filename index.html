<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WWS Audio Call</title>
<style>
body { 
    font-family: Arial, sans-serif; 
    text-align: center; 
    background: #111; 
    color: white; 
    margin: 0;
    padding: 20px;
}
.container {
    max-width: 600px;
    margin: 0 auto;
    padding: 20px;
    background: #222;
    border-radius: 10px;
    box-shadow: 0 0 20px rgba(0,0,0,0.5);
}
button { 
    padding: 12px 24px; 
    margin: 10px; 
    background: #4CAF50;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 16px;
    transition: background 0.3s;
}
button:hover {
    background: #45a049;
}
input { 
    padding: 12px; 
    width: 200px;
    border: 1px solid #444;
    border-radius: 5px;
    background: #333;
    color: white;
}
.status {
    margin: 20px 0;
    padding: 10px;
    background: #333;
    border-radius: 5px;
}
</style>
</head>
<body>

<div class="container">
    <h2>WWS Audio Call</h2>
    
    <div class="status">
        <p>ID пользователя: <span id="userIdDisplay"></span></p>
        <p>Комната: <span id="roomIdDisplay">Не подключено</span></p>
    </div>
    
    <button onclick="createRoom()">Создать комнату</button>
    
    <br><br>
    
    <input id="roomInput" placeholder="ID комнаты (6 символов)">
    <button onclick="joinRoom()">Войти в комнату</button>
</div>

<script>
const API_URL = "https://functions.yandexcloud.net/d4etraj6pl3ep8uj8cd8";

let localStream;
let roomId;
let userId = 'user_' + Math.random().toString(36).substring(2, 9);

// Отображение ID пользователя
document.getElementById('userIdDisplay').textContent = userId;

async function createRoom() {
    try {
        const response = await fetch(`${API_URL}/room`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-User-Id": userId
            },
            body: JSON.stringify({ userId: userId })
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success && data.roomId) {
            roomId = data.roomId;
            document.getElementById('roomIdDisplay').textContent = roomId;
            
            alert("✅ Комната создана: " + roomId + "\nПоделитесь этим ID с другими участниками");
            
            // Автоматически присоединяемся к созданной комнате
            await joinExistingRoom(roomId);
        } else {
            throw new Error("Неверный ответ от сервера");
        }
    } catch (error) {
        console.error("Error creating room:", error);
        alert("❌ Ошибка при создании комнаты: " + error.message);
    }
}

async function joinRoom() {
    const inputRoomId = document.getElementById("roomInput").value.trim().toUpperCase();
    
    if (!inputRoomId) {
        alert("Введите ID комнаты");
        return;
    }
    
    if (inputRoomId.length !== 6) {
        alert("ID комнаты должен состоять из 6 символов");
        return;
    }
    
    await joinExistingRoom(inputRoomId);
}

async function joinExistingRoom(roomIdToJoin) {
    try {
        // Запрашиваем доступ к микрофону
        localStream = await navigator.mediaDevices.getUserMedia({ 
            audio: {
                echoCancellation: true,
                noiseSuppression: true,
                autoGainControl: true
            }
        });
        
        // Присоединяемся к комнате через API
        const response = await fetch(`${API_URL}/room/${roomIdToJoin}/join`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-User-Id": userId
            },
            body: JSON.stringify({ 
                userId: userId,
                userName: `User_${userId.substring(0, 4)}`
            })
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (!data.success) {
            throw new Error(data.error || 'Не удалось присоединиться к комнате');
        }
        
        roomId = roomIdToJoin;
        document.getElementById('roomIdDisplay').textContent = roomId;
        
        alert("✅ Успешно присоединились к комнате!");
        
        // Здесь будет логика для WebRTC соединения с другими участниками
        // Для начала можно просто показать, что подключение успешно
        console.log("Connected to room:", roomId);
        console.log("Local stream:", localStream);
        
    } catch (error) {
        console.error("Error joining room:", error);
        
        if (error.name === "NotAllowedError") {
            alert("❌ Доступ к микрофону запрещен. Разрешите доступ к микрофону и попробуйте снова.");
        } else {
            alert("❌ Ошибка при подключении к комнате: " + error.message);
        }
    }
}

// Очистка при закрытии страницы
window.addEventListener('beforeunload', async () => {
    if (roomId && userId) {
        try {
            // Отправляем запрос на выход из комнаты
            await fetch(`${API_URL}/room/${roomId}/leave`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ userId: userId })
            });
            
            // Останавливаем локальный поток
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }
        } catch (error) {
            console.error("Error during cleanup:", error);
        }
    }
});

// Проверка соединения
async function testConnection() {
    try {
        const response = await fetch(API_URL, {
            method: 'OPTIONS'
        });
        
        if (response.ok) {
            console.log("✅ Подключение к серверу успешно!");
        } else {
            console.error("❌ Ошибка подключения:", response.status);
        }
    } catch (error) {
        console.error("❌ Сетевая ошибка:", error.message);
    }
}

// Тестируем подключение при загрузке
window.addEventListener('load', testConnection);
</script>
</body>
</html>
